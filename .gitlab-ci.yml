# GitLab CI/CD Pipeline for Kalamar-Plugin-Export
# This pipeline runs tests on pushes and builds Docker containers on tag pushes and manual triggers

stages:
  - test
  - build
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository/

# Test stage - runs on all pushes
test:
  stage: test
  image: eclipse-temurin:22-jdk-alpine
  before_script:
    - apk add --no-cache maven
    - export MAVEN_OPTS="$MAVEN_OPTS"
  script:
    - mvn $MAVEN_CLI_OPTS clean test
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  only:
    - pushes
    - merge_requests

# Build Docker image stage
build-docker:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - docker build -t korap/kalamar-plugin-export:${CI_COMMIT_TAG:-latest} .
    - docker build -t korap/kalamar-plugin-export:latest .
  only:
    - tags
    - web
  when: manual
  allow_failure: false

# Security scan stage (optional)
security-scan:
  stage: build
  image: eclipse-temurin:22-jdk-alpine
  before_script:
    - apk add --no-cache maven
  script:
    - mvn $MAVEN_CLI_OPTS clean compile
  allow_failure: true
  only:
    - tags
    - web
  when: manual

# Deploy stage (placeholder for actual deployment)
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - curl --version
  only:
    - tags
  when: manual
  allow_failure: false
